; OnSpeed Gen3 ESP32 PlatformIO Configuration
;
; This provides reproducible builds without Arduino IDE dependency.
; To use: Install PlatformIO (https://platformio.org/)
;
; Commands:
;   pio run              - Build firmware
;   pio run -t upload    - Build and upload to device
;   pio run -t clean     - Clean build artifacts
;   pio device monitor   - Serial monitor (921600 baud)

[platformio]
name = OnSpeed-Gen3
description = Open source AOA indicator with audio cues for general aviation
license = MIT

[env:esp32s3]
; This project requires Arduino ESP32 Core 3.x for the ESP_I2S library.
; Use pioarduino community platform which provides Arduino Core 3.x support.
; See: https://github.com/pioarduino/platform-espressif32
platform = https://github.com/pioarduino/platform-espressif32/releases/download/54.03.20/platform-espressif32.zip

; Target hardware: ESP32-S3-WROOM-2-N32R8V (32MB Flash Octal, 8MB PSRAM Octal)
board = esp32-s3-devkitc-1-n32r8v
framework = arduino

; Exclude native-only files from ESP32 build
build_src_filter = +<*> -<native_main.cpp>

; Generate buildinfo.cpp before build (updates version from git tags)
extra_scripts = pre:scripts/generate_buildinfo.py

; Flash settings for 32MB Octal SPI flash
; Match Arduino IDE: Flash Mode "OPI 80 MHz", Flash Size "32MB (256 Mb)"
board_build.flash_mode = opi
board_build.f_flash = 80000000L
board_build.flash_size = 32MB
board_build.partitions = default_32MB.csv

; Upload settings
upload_speed = 921600
monitor_speed = 921600

; Build flags for ESP32-S3 with PSRAM
build_flags =
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -Wall
    -Wextra
    -Wno-unused-parameter
    -Wno-missing-field-initializers
    -I src

; Compiler warnings
build_unflags = -Werror=all

lib_deps =
    ; SD card filesystem
    greiman/SdFat@2.3.1

    ; Button handling
    mathertel/OneButton@2.6.1

    ; Temperature sensors (OAT)
    paulstoffregen/OneWire@2.3.8
    milesburton/DallasTemperature@4.0.5

    ; WebSocket server for live data
    links2004/WebSockets@2.7.1

    ; Status LED
    adafruit/Adafruit NeoPixel@1.15.2

    ; Signal processing / filtering
    robtillaart/RunningAverage@0.4.8
    robtillaart/RunningMedian@0.3.10
    https://github.com/jmderomedi/SavitzkyGolayFilter.git#V1.0.1

    ; XML config parsing (using GitHub - PlatformIO package is broken)
    https://github.com/leethomason/tinyxml2.git#11.0.0

; Local libraries in lib/ (vendored, not in PlatformIO registry)
; csv-parser, version
lib_extra_dirs =
    lib

build_type = release

; =============================================================================
; Native test environment - runs on host machine, not ESP32
; =============================================================================
; This allows testing pure math/logic functions without hardware.
; Run with: pio test -e native
;
; Testable modules are in lib/onspeed_core/ (moved there for PlatformIO compat)
;
[env:native]
platform = native

; Don't compile src/ for native - only libs and tests
build_src_filter = -<*>

build_flags =
    -std=c++17
    -DUNIT_TEST
    -DNATIVE_BUILD
    ; Stub out Arduino-specific things
    -include test/native_stubs.h

test_framework = unity
test_filter = test_*

lib_deps =
    throwtheswitch/Unity@^2.5.2

; =============================================================================
; Native test environment with code coverage (Linux CI only)
; =============================================================================
; This environment is designed for Linux CI with GCC. It will NOT work on macOS
; due to clang not supporting gcov-compatible coverage flags.
;
; CI Usage:
;   pio test -e native-coverage
;   lcov -c -d .pio/build/native-coverage -o coverage.info --rc lcov_branch_coverage=1
;   lcov --remove coverage.info '*/test/*' '*/Unity/*' -o coverage.info
;   genhtml coverage.info -o coverage-report
;
; For codecov.io, upload coverage.info after filtering.
;
[env:native-coverage]
platform = native

; Don't compile src/ for native - only libs and tests
build_src_filter = -<*>

build_flags =
    -std=c++17
    -DUNIT_TEST
    -DNATIVE_BUILD
    -include test/native_stubs.h
    ; Coverage flags for GCC (Linux CI)
    -fprofile-arcs
    -ftest-coverage
    -O0
    -g

; Link with gcov - add coverage to link step via build_flags
build_unflags = -Os -O2 -O3
; Note: --coverage is equivalent to -fprofile-arcs -ftest-coverage for compile
; and -lgcov for link, so we add it to build_flags which affects both
extra_scripts = pre:scripts/coverage_link.py

test_framework = unity
test_filter = test_*

lib_deps =
    throwtheswitch/Unity@^2.5.2

