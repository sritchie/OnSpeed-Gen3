; OnSpeed Gen3 ESP32 PlatformIO Configuration
;
; This provides reproducible builds without Arduino IDE dependency.
; To use: Install PlatformIO (https://platformio.org/)
;
; Commands:
;   pio run              - Build firmware
;   pio run -t upload    - Build and upload to device
;   pio run -t clean     - Clean build artifacts
;   pio device monitor   - Serial monitor (921600 baud)
;
; Benefits over Arduino IDE:
;   - Command-line builds (CI/CD friendly)
;   - Pinned dependency versions
;   - Reproducible across machines
;   - Better library management

[env:esp32s3]
; This project requires Arduino ESP32 Core 3.x for the ESP_I2S library.
; Use pioarduino community platform which provides Arduino Core 3.x support.
; See: https://github.com/pioarduino/platform-espressif32
platform = https://github.com/pioarduino/platform-espressif32/releases/download/54.03.20/platform-espressif32.zip
board = esp32-s3-devkitc-1
framework = arduino

; Exclude native-only files from ESP32 build
build_src_filter = +<*> -<native_main.cpp>

; Generate buildinfo.cpp before build (updates version from git tags)
extra_scripts = pre:scripts/generate_buildinfo.py

; Match Arduino IDE settings from README.md
board_build.flash_mode = qio
board_build.flash_size = 16MB
board_build.partitions = default_16MB.csv

; Upload settings
upload_speed = 921600
monitor_speed = 921600

; Build flags for ESP32-S3 with PSRAM
build_flags =
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -Wall
    -Wextra
    -Wno-unused-parameter
    -Wno-missing-field-initializers
    ; Include main source directory for lib/ files that need Globals.h etc.
    -I src

; Compiler warnings
build_unflags = -Werror=all

; Library dependencies - all from PlatformIO registry or GitHub
; This eliminates the need for git submodules
lib_deps =
    ; Core sensor/peripheral libraries
    greiman/SdFat@^2.2.2
    mathertel/OneButton@^2.5.0
    paulstoffregen/OneWire@^2.3.8
    milesburton/DallasTemperature@^3.11.0

    ; Communication libraries
    links2004/WebSockets@^2.4.1
    bblanchon/ArduinoJson@^7.0.0

    ; Display/LED
    adafruit/Adafruit NeoPixel@^1.12.0

    ; Signal processing
    robtillaart/RunningAverage@^0.4.6
    robtillaart/RunningMedian@^0.3.9
    tomstewart89/BasicLinearAlgebra@^5.0.0

    ; Serial communication
    plerup/EspSoftwareSerial@^8.0.0

    ; Libraries not in registry - use GitHub directly
    ; tinyxml2 is vendored in lib/tinyxml2 (not in PlatformIO registry)
    https://github.com/jmderomedi/SavitzkyGolayFilter.git#V1.0.1

; Local libraries (project-specific, not external dependencies)
; onspeed_core contains shared math code (CurveCalc, KalmanFilter)
; onspeed_native is native-only stubs
lib_extra_dirs =
    lib

lib_ignore =
    onspeed_native

; Build settings
build_type = release

; OTA settings (optional)
; upload_protocol = espota
; upload_port = onspeed.local

[env:esp32s3-debug]
extends = env:esp32s3
build_type = debug
build_flags =
    ${env:esp32s3.build_flags}
    -DDEBUG
    -DCORE_DEBUG_LEVEL=4

; Custom partition table for 32MB flash
; 4.8MB APP / 22MB LittleFS as per README
[env:esp32s3-custom]
extends = env:esp32s3
board_build.partitions = partitions_custom.csv

; =============================================================================
; Native test environment - runs on host machine, not ESP32
; =============================================================================
; This allows testing pure math/logic functions without hardware.
; Run with: pio test -e native
;
; Testable modules are in lib/onspeed_core/ (moved there for PlatformIO compat)
;
[env:native]
platform = native

build_flags =
    -std=c++17
    -DUNIT_TEST
    -DNATIVE_BUILD
    ; Stub out Arduino-specific things
    -include test/native_stubs.h

test_framework = unity
test_filter = test_*

lib_deps =
    throwtheswitch/Unity@^2.5.2

; =============================================================================
; Native test environment with code coverage (Linux CI only)
; =============================================================================
; This environment is designed for Linux CI with GCC. It will NOT work on macOS
; due to clang not supporting gcov-compatible coverage flags.
;
; CI Usage:
;   pio test -e native-coverage
;   lcov -c -d .pio/build/native-coverage -o coverage.info --rc lcov_branch_coverage=1
;   lcov --remove coverage.info '*/test/*' '*/Unity/*' -o coverage.info
;   genhtml coverage.info -o coverage-report
;
; For codecov.io, upload coverage.info after filtering.
;
[env:native-coverage]
platform = native

build_flags =
    -std=c++17
    -DUNIT_TEST
    -DNATIVE_BUILD
    -include test/native_stubs.h
    ; Coverage flags for GCC (Linux CI)
    -fprofile-arcs
    -ftest-coverage
    -O0
    -g

; Link with gcov - add coverage to link step via build_flags
build_unflags = -Os -O2 -O3
; Note: --coverage is equivalent to -fprofile-arcs -ftest-coverage for compile
; and -lgcov for link, so we add it to build_flags which affects both
extra_scripts = pre:scripts/coverage_link.py

test_framework = unity
test_filter = test_*

lib_deps =
    throwtheswitch/Unity@^2.5.2

; =============================================================================
; Native replay environment - CSV replay through real C++ processing pipeline
; =============================================================================
; Run with: pio run -e native-replay
; Execute: .pio/build/native-replay/program path/to/log.csv
;
[env:native-replay]
platform = native

; Only build native_main.cpp for the replay executable
build_src_filter = +<native_main.cpp>

build_flags =
    -std=c++17
    -DNATIVE_BUILD
    -include lib/onspeed_native/native_compat.h
