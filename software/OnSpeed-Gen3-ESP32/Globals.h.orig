
#ifndef GLOBALS_H
#define GLOBALS_H

#ifdef MAIN
#define EXTERN
#define EXTERN_INIT(var, init)    var = init;
#define EXTERN_CLASS(var, ...)    var(__VA_ARGS__);
#else
#define EXTERN                    extern 
#define EXTERN_INIT(var, init)    extern var;
#define EXTERN_CLASS(var, ...)    extern var;
#endif

#include <arduino.h>

#define VERSION "3.3.7a" // optimized AHRS parameters for better pitch performance during AOA calibration
//"3.3.7" // fixed dumb mistake of using TAS in kts instead of m/sec in the AHRS airspeed correction when OAT enabled.
//"3.3.6" // added capability to save screenshots of calibration results on the Wifi interface, and confirm before saving calibration to settings. (wifi code also updated)
                        // Wifi code is compiled, just upload OnSpeedWifi.ino.pico32.bin filen to upgrade to 3.3.6
//"3.3.5" // fixed error in adaptive smoothing.
//"3.3.4" //fixed reboot on config load/save, and added HIGHRES_ANALOGREAD to have better resolution when reading volume and flap potentiometers.
//"3.3.3"  // 3/1/2023 Adaptive pitch filtering for smoother internal AHRS derived pitch angles, useful for IMU based calibration.
//"3.3.2" // 1/29/2023 Fixed TAS formula, and added TAS to the log file.
//"3.3.1" // 1/28/2023  Added functionality to read digital OAT sensor DS18B20 on Pin 9. To enable uncomment the #define OAT_AVAILABLE line. Needs two new libraries: OneWire.h  and DallasTemperature.h
//"3.3.0" //12/4/2022 fixed KalmanVSI (reading Pstatic at 208Hz together with IMU). Added calibration data source to Wifi display. Requires wifi firmware upgrade!
//"3.2.3.g3" //Bob's MGL parser fix and optimization
//"3.2.3f" // 7/17/2022 Fixed VSI unit conversion issue and Roll calibration direction.
//"3.2.3e" //7/15/2021 Covid-affected update, proceed with caution. Added checksums to data download. Also change comm speeds to 1,000,000bps
//"3.2.3d" // 7/14/2022 tuned kalmanVSI filter
//"3.2.3c" // 7/12/2022 another switch glitch fix
//"3.2.3b" //mgl updates. VSI.
//"3.2.3a" //interrupt based push button, updated OneButton library
//"3.2.3" // modified and tuned AHRS and iVSI code for the new IMS330 IMU, do not use this code with the old IMS9DS1 IMU, more responsive Datamark button
//"3.2.2r"  6/2/2022//MGL efis input
//"3.2.2q" //disabled IMU gyro LPF1 filter, really disabled high pass filter this time...
//"v3.2.2p" // 6/2/2022 disabled IMU gyro hardware high pass filter
//"v3.2.2o" // 5/28/2022  changed logged pitch and roll resolution to 2 digits, fixed VN-300 parser
//"v3.2.2n" // 5/11/2022  Added code to read new IMU ISM330DHXC, fixed large config file saving issue
//"v3.2.2m" // 3/26/2022 use efisIAS with calibration wizard if equiped with spherical probe
//"v3.2.2j" // 3/15/2022 Added ability to run the calibration wizard with efis data, fixed AFS data parsing glitch. Yeah a second j version :)
//"v3.2.2l"     // 2/9/2022 Added full card erase before card format. Results in much faster data writes. Also fixed SD card init issues after formatting.
//"v3.2.2k"     // 1/27/2022 added NOBOOMCHECKSUM option to accomodate flight test booms with no checksum in their datastream
//"v3.2.2j"     // 12/5/2021 rolled in Spherical probe curves
//"v3.2.2i"     // improved serial data processing, boom/efis
//"v3.2.2h"     // 12/1/2021 fixed serial data processing
//"v3.2.2g"     // added IMU temp logging, fixed wifi transfer issue (update wifi code to same version)
//"v3.2.2f1"    // 10/22/2021 fixed VN-300 parser issue, 
//"v3.2.2f"     // added AHRS corrections for IMU installation errors and flightpath calculation. Calibration Wizard on the Wifi side. Added VN-300 GPS lat/lon to logs. Reconfigure Vn-300 output format, add [Common] Group 1 / "Position" output
// 5/25/2021     //switched over to CP3
//"v3.2.1a"     // 3/15/2021 fixed boom curves
//"v3.2"        // static pressure bias, roll bias and cas curve type
//"v3.1.7"      // 12/08/2020 hardcoded better boom curves (4th order polys)
//"v3.1.6"      // 11/29/2020 fix box orientation left/up
//"v3.1.5"      // 11/5/2020 boom debug displays raw counts from boom data
//"v3.1.4"      // 10/23/2020 energy display improvements
//"v3.1.3"    // 10/7/2020 added serial display data smoothing, constrained %lift to 0-99%
//"v3.1.2"    // 9/29/2020 kick the dog during file transfer, fixed verticalG rounding
//"v3.1.1"    // 9/25/2020 kick the dog during sensorconfig so it doesn't reboot the box
//"v3.1"      // 9/14/2020 tuned AHRS, added watchdog timer, fixed interrupt conflict
//"v3.0.95"   // 8/28/2020 modified AHRS centripetal correction again
//"v3.0.9"    // 8/28/2020 fixed AHRS centripetal correction
//"v3.0.7"    // last modified 8/18/2020  added AHRS code (Madgwick filter with centripetal correction)
//"v3.0.65"   // last modified 8/06/2020 added Serial port 1 G3x output for display TTL data TX on v2 boxes (Vac & Lenny).
//"v3.0.6"    // last modified 5/12/2020 replaced Gaussian with exponential moving average filter
//"v3.0.5"    // last modified 4/22/2020 added Vno chime
//"v3.0.4"    // last modified 4/7/2020 modified coefficient of pressure formula
//"v3.0.3"    // last modified 3/15/2020 updated AI-Pitch network parameters
//"v3.0.2"    // last modified 3/10/2020 fixed pitchBias, confirm flap position delete, fixed Glimit audio
//"v3.0.1"    // last modified 3/8/2020 added neural network based pitch calculation
//"v3.0"      // last modified 2/28/2020 added wifi based configuration settings, asymmetric overG warning, sensor configuration, serial data output (G3X format)
//"v2.1.28"   // last modified 2/1/2020 (timed serial read) 
//"v2.1.28"   // last modified 1/31/2020 (added boom CRC)
//"v2.1.27"   // last modified 1/10/2020 (fixed G3x data parsing, crc + oat errors)
//"v2.1.26.5" // last modified 1/9/2020 (implemented ring buffer write for SD card)
//"v2.1.26"   // last modified 1/9/2020 (fixed volume control update rate)
//"v2.1.25"   // last modified 1/6/2020  (added boom junk data filter) 
//"v2.1.24"   // last modified 1/5/2020 (new 3d audio code & curve, new boom parsing code, new volume control code)
//"v2.1.23"   // last modified 1/5/2020 (fixed 3D audio curve going negative)
//"v2.1.22"   // last modified 1/4/2020 (setting mixer gain instead of individual tone volumes)
//"v2.1.21"   // last modified 1/4/2020 (added AUDIOTEST help description, and fixed Volume control sticking, add volume control during Logreplay)
//"v2.1.20"   // last modified 1/1/2020 by Lenny (added AUDIOTEST! command to test left/right audio channels, important for 3D audio)
//"v2.1.19"   // last modified 12/27/2019 by Lenny (added 3D audio. Define an audio curve in aircraft config file)

//interrupt priorities:
//Tones 96
//IMU 128
//Sensors 128


// debug config. Comment out any of them to disable serial debug output.
//#define SENSORDEBUG                             // show sensor debug
//#define EFISDATADEBUG                           // show efis data debug
//#define BOOMDATADEBUG                           // show boom data debug
//#define TONEDEBUG                               // show tone related debug info
//#define SDCARDDEBUG                             // show SD writing debug info
//#define VOLUMEDEBUG                             // show audio volume info
//#define VNDEBUG                                 // show VN-300 debug info
//#define AXISDEBUG                               // show accelerometer axis configuration
//#define IMUTEMPDEBUG
//#define AGEDEBUG                                // debug data age (boom,efis [ms])

#define DEFAULT_CONFIG  default_config

// data logging frequency
#define LOGDATA_PRESSURE_RATE
//#define LOGDATA_IMU_RATE

// AOA probe type
//#define SPHERICAL_PROBE // uncomment this if using custom OnSpeed spherical head probe.

// imu type
//#define IMUTYPE_LSM9DS1  // original IMU
////////#define IMUTYPE_ISM330DHCX // new IMU with less temperature drift

// boom type
//#define NOBOOMCHECKSUM    // for booms that don't have a checksum byte in their data stream uncomment this line.

// curves config
#define MAX_AOA_CURVES    5 // maximum number of AOA curves (flap/gear positions)
#define MAX_CURVE_COEFF   4 // 4 coefficients=3rd degree polynomial function for calibration curves

// glimit settings
#define GLIMIT_REPEAT_TIMEOUT   3000 // milliseconds to repeat G limit.
#define ASYMMETRIC_GYRO_LIMIT   15 // degrees/sec rotation on either axis to trigger asymmetric G limits.

// coefficient of pressure formula
#ifdef SPHERICAL_PROBE
  #define PCOEFF(p_fwd,p_45)    atan2(p_45,p_fwd); //spherical CP3
  #define IASCURVE(x)           -3.206e-05*x*x*x+0.008454*x*x+0.3492*x+27.73; // Zlin IAS curve
#else
  #define PCOEFF(p_fwd,p_45)  p_45/p_fwd; // CP3 // ratiometric CP. CP1 & CP2 are not ratiometric. Can't divide with P45, it goes through zero on Dynon probe.
#endif

// OAT sensor available
//#define OAT_AVAILABLE  // DS18B20 sensor on pin 9

// boom curves
//#define BOOM_ALPHA_CALC(x)      7.0918*pow(10,-13)*x*x*x*x - 1.1698*pow(10,-8)*x*x*x + 7.0109*pow(10,-5)*x*x - 0.21624*x + 310.21; //degrees
//#define BOOM_BETA_CALC(x)       2.0096*pow(10,-13)*x*x*x*x - 3.7124*pow(10,-9)*x*x*x + 2.5497*pow(10,-5)*x*x - 3.7141*pow(10,-2)*x - 72.505; //degrees
//#define BOOM_STATIC_CALC(x)     0.00012207*(x - 1638)*1000; // millibars
//#define BOOM_DYNAMIC_CALC(x)    (0.01525902*(x - 1638)) - 100; // millibars

// log raw counts for boom, no curves
#define BOOM_ALPHA_CALC(x)      x
#define BOOM_BETA_CALC(x)       x
#define BOOM_STATIC_CALC(x)     x
#define BOOM_DYNAMIC_CALC(x)    x

// serial data packet size
#define BOOM_PACKET_SIZE  50
#define EFIS_PACKET_SIZE 512

//analog resolution (use 13 bit analog resolution, default is 10-bit)
//#define HIGHRES_ANALOGREAD

// IMU defines

#if defined(IMUTYPE_LSM9DS1)
  #define LSM9DS1_Magnet    0x1E
  // LSM9DS1 Accel/Gyro (XL/G) Registers
  #define CTRL_REG5_XL      0x1F
  #define CTRL_REG6_XL      0x20
  #define CTRL_REG7_XL      0x21
  #define OUT_X_L_XL        0x28
  #define CTRL_REG4         0x1E
  #define CTRL_REG1_G       0x10
  #define OUT_X_L_G         0x18
  #define OUT_TEMP_L        0x15
  #define OUT_TEMP_H        0x16
  #define CTRL_REG8         0x22
  #define CTRL_REG9         0x23
  #define STATUS_REG_1      0x27 // status register, is data available?
  #define FIFO_CTRL         0x2E // enable FIFO in IMU
  #define FIFO_SRC          0x2F // FIFO status register
  #define LSM9DS1_TEMP_SCALE 16.0
  #define LSM9DS1_TEMP_BIAS 25.0
  #define _i2cAddress_AccelGyro 0x6B // chip address
  #define aRes             8.0 / 32768.0 // full scale /resolution (8G)
  #define gRes             245.0 / 32768.0 // full scale / resolution (245 dps)

#elseif defined(IMUTYPE_ISM330DHCX)
  // define ISM330 registers
  #define _i2CAddressISM330 0x6A // chip address on I2C bus
  #define CTRL1_XL 0x10 // accelerometer control register  
  #define CTRL2_G 0x11 // gyro control register
  #define CTRL3_C 0x12
  #define CTRL4_C 0x13
  #define CTRL9_XL 0x18
  #define CTRL7_G 0x16
  #define CTRL6_C 0x15
  #define OUTX_L_A 0x28 // start of accelerometer output address
  #define OUTX_L_G 0x22 // start of gyro output address
  #define ISM330_OUT_TEMP_L 0x20 // temp output register 
  #define ISM330_OUT_TEMP_H 0x21
  #define FIFO_CTRL4 0x0A
  #define ISM330_TEMP_SCALE 256.0
  #define ISM330_TEMP_BIAS 25.0
  #define aRes             8.0 / 32768.0 // full scale /resolution (8G)
  #define gRes             250.0 / 32768.0 // full scale / resolution (250 dps)

#else
  #define aRes             8.0 / 32768.0 // full scale /resolution (8G)
  #define gRes             245.0 / 32768.0 // full scale / resolution (245 dps)
#endif

#define DEG2RAD 0.0174533 // degrees to radians
#define RAD2DEG 57.2958 // radians to degrees
#define G2MPS   9.80665  // g to m/sec^2
#define MPS2G   0.101971621 // m/sec^2 to g
#define FT2M    0.3048 // feet to meters
#define M2FT    3.28084 // meters to feet
#define MPS2FPM 196.85 // m/sec to fpm
#define MPS2KTS 1.94384 // m/sec to fpm
#define KTS2MPS 0.514444 // m/sec to fpm

#define I2C_COMMUNICATION_TIMEOUT 2000  // microseconds

// box functionality config
//EXTERN String dataSource        = "TESTPOT"; // potentiometer wiper on Pin 10 of DSUB 15 connector
//EXTERN String dataSource        = "RANGESWEEP";
EXTERN_INIT(String dataSource, "SENSORS")
//EXTERN String dataSource        = "REPLAYLOGFILE";
EXTERN_INIT(String replayLogFileName, "")

// type definitions
typedef struct  {
  int Count;
  int Items[MAX_AOA_CURVES];
} intArray;

typedef struct  {
  int Count;
  float Items[MAX_AOA_CURVES];
} floatArray;

typedef struct  {
  float Items[MAX_CURVE_COEFF]; // 3rd degree polynomial
  uint8_t curveType; // 1 - polynomial, 2 - logarithmic (linear is 1 degree polynomial), 3 -exponential
} calibrationCurve;

// configfile
EXTERN_INIT(char configFilename[14],"onspeed.cfg")
EXTERN_INIT(bool configLoaded,false)

//serial inputs
EXTERN bool readBoom;                             // boom connected to Serial 1
EXTERN bool readEfisData;                         // Serial3, read and log serial data 
                                                  // (ahrs/aoa/airspeed/altitude data from Dynon EFIS D10, 
                                                  // D100, D180, Skyview/ADVANCED, Garmin G5 and G3X, MGL)
EXTERN bool casCurveEnabled;

EXTERN_INIT(int lineCount, 0)                     // log replay variable

// serial output
EXTERN String serialOutFormat;
EXTERN String serialOutPort;
EXTERN byte serialCRC;

//volume & audio control
EXTERN bool volumeControl;
EXTERN bool audio3D;
EXTERN_INIT(int volumeHighAnalog, 1023)
EXTERN_INIT(int volumeLowAnalog, 1)
// Min airspeed in knots before the audio tone is turned on
EXTERN_INIT(int muteAudioUnderIAS, 30)
EXTERN int volumePercent; // %volume
EXTERN int defaultVolume;
EXTERN_INIT(bool ledOn, false)

// switch state
EXTERN_INIT(bool switchDoSingleClick, false)
EXTERN_INIT(bool switchDoLongPress, false)

EXTERN_INIT(volatile bool timersDisabled, false)

// timers
EXTERN_INIT(unsigned long audio3dLastUpdate, millis())
EXTERN_INIT(unsigned long volumeLastUpdate, millis())
EXTERN_INIT(unsigned long serialoutLastUpdate, millis())
EXTERN_INIT(unsigned long gLimitLastWarning, millis())
EXTERN_INIT(unsigned long gLimitLastUpdate, millis())
EXTERN_INIT(unsigned long vnoLastChime, millis())
EXTERN_INIT(unsigned long vnoChimeLastUpdate, millis())
EXTERN_INIT(unsigned long wifiDataLastUpdate, millis())
EXTERN_INIT(unsigned long lastSDWrite, millis())
EXTERN_INIT(unsigned long lastLedUpdate, millis())
EXTERN_INIT(unsigned long lastImuTempUpdate, millis())
EXTERN_INIT(unsigned long lastDecelUpdate, millis())
EXTERN_INIT(unsigned long lastOATUpdate, millis())

EXTERN volatile unsigned long lastWatchdogRefresh;
EXTERN_INIT(volatile bool watchdogEnabled, false)

EXTERN_INIT(unsigned long lastReplayOutput, millis())

EXTERN_INIT(unsigned long displayDataSendTime, millis())

#define AUDIO_3D_CURVE(x)         -92.822*x*x + 20.025*x //move audio with the ball, scaling is 0.08 LateralG/ball width
EXTERN bool overgWarning;                         // 0 - off, 1 - on
EXTERN_INIT(float channelGain, 1.0)
EXTERN float calculatedGLimitPositive;
EXTERN float calculatedGLimitNegative;


// smoothing windows
EXTERN_INIT(int aoaSmoothing, 20)                   // AOA smoothing window (number of samples to lag)
EXTERN_INIT(int pressureSmoothing, 15)              // median filter window for pressure smoothing/despiking

EXTERN_INIT(const int accSmoothing, 192)            // accelerometer smoothing, Simple moving average
EXTERN_INIT(const int imuTempSmoothing, 20)         // imu temperature smoothing, Simple moving average, 10 = 1 second
//EXTERN const int imuTempRateSmoothing=5;          // imu temperature smoothing, Simple moving average
EXTERN_INIT(const int gyroSmoothing, 30)            // gyro smoothing, Simple moving average
EXTERN_INIT(const int compSmoothing, 20)            // acceleration compensation smoothing (linear and centripetal)
EXTERN_INIT(const int iasSmoothing, 66)             // airspeed smoothing, 66 sample moving average for 208hz [optimized for ISM330 IMU]
EXTERN_INIT(const int tasSmoothing, 10)             // [optimized for ISM330 IMU]
EXTERN_INIT(int ahrsSmoothing, 50)                  // ahrs smoothing, Exponential
EXTERN_INIT(int serialDisplaySmoothing, 10)         // smoothing serial display data (LateralG, verticalG)  10hz data.
EXTERN_INIT(float gyroScaleCorrection, 1.14)        // [optimized for ISM330 IMU]

EXTERN intArray flapDegrees;
EXTERN intArray flapPotPositions;

// calibration curves
EXTERN calibrationCurve   aoaCurve[MAX_AOA_CURVES]; // curve equation coefficents
EXTERN calibrationCurve   boomAlphaCurve;
EXTERN calibrationCurve   boomBetaCurve;
EXTERN calibrationCurve   boomStaticCurve;
EXTERN calibrationCurve   boomDynamicCurve;
EXTERN calibrationCurve   casCurve;                 // calibrated airspeed curve (polynomial)

//setpoints
EXTERN floatArray flapLDMAXAOA;
EXTERN floatArray flapONSPEEDFASTAOA;
EXTERN floatArray flapONSPEEDSLOWAOA;
EXTERN floatArray flapSTALLWARNAOA;
EXTERN floatArray flapSTALLAOA;
EXTERN floatArray flapMANAOA;

//box orientation
EXTERN String portsOrientation;
EXTERN String boxtopOrientation;

// load factor limit
EXTERN float loadLimitPositive;
EXTERN float loadLimitNegative;

// vno chime
EXTERN bool vnoChimeEnabled;
EXTERN unsigned int       vnoChimeInterval;       // chime interval in seconds
EXTERN int Vno; // aircraft Vno in kts;

// IMU orientation
EXTERN_INIT(String verticalGloadAxis, "")
EXTERN_INIT(String lateralGloadAxis, "")
EXTERN_INIT(String forwardGloadAxis, "")
EXTERN_INIT(String pitchGyroAxis, "")
EXTERN_INIT(String rollGyroAxis, "")
EXTERN_INIT(String yawGyroAxis, "")

// sensor biases
EXTERN int pFwdBias;
EXTERN int p45Bias;
EXTERN_INIT(float pStaticBias, 0)
EXTERN float gxBias;
EXTERN float gyBias;
EXTERN float gzBias;
EXTERN_INIT(float pitchBias, 0.0)
EXTERN_INIT(float rollBias, 0.0)

// AHRS variables
EXTERN_INIT(volatile float earthVertG, 0.0)
EXTERN_INIT(volatile bool newSensorDataAvailable, false)

#if defined(IMUTYPE_LSM9DS1)
EXTERN_INIT(float imuSampleRate, 238) // 238Hz. 50hz for replay
#elseif defined(IMUTYPE_ISM330DHCX)
EXTERN_INIT(float imuSampleRate, 208) // 208Hz.
#else
EXTERN_INIT(float imuSampleRate, 50) // No IMU
#endif

EXTERN_INIT(volatile bool sendWifiData, false)
EXTERN_INIT(int displayDataCounter, 0)
EXTERN_INIT(int imuIndex, 0)                      // used for logreplay

// data mark
EXTERN_INIT(volatile int dataMark, 0)

EXTERN volatile double      coeffP;               // coefficient of pressure

#ifdef LOGDATA_PRESSURE_RATE                      // sd card write rate
  #define SD_WRITE_TIME 1000
#else
  #define SD_WRITE_TIME 400
#endif



// interval timers
#define SENSOR_INTERVAL 20000  // microsecond interval for sensor read (50hz)
//#define SENSOR_INTERVAL 4201 // 238hz logging
//#define REPLAY_INTERVAL 4201.680672268907563
#define REPLAY_INTERVAL 20000 // 4808 for 208hz
#if defined(IMUTYPE_LSM9DS1)
#define IMU_INTERVAL    4200 // microseconds interval for IMU read
#elseif defined(IMUTYPE_ISM330DHCX)
#define IMU_INTERVAL    4808 // microseconds interval for IMU read
#else
#define IMU_INTERVAL   20000 // No IMU
#endif

// max possible AOA value
#define AOA_MAX_VALUE         40  // was 20 before, but in a sudden stall when the nose quickly goes up, AOA gets larger very quickly and then onspeed goes silent right as the aircraft stalls

 // min possible AOA value
#define AOA_MIN_VALUE         -20

//Tone Pulse Per Sec (PPS)
#define HIGH_TONE_STALL_PPS    20                 // how many PPS to play during stall
#define HIGH_TONE_PPS_MAX       6.2     
#define HIGH_TONE_PPS_MIN       1.5               // 1.5
#define HIGH_TONE_HZ         1600                 // freq of high tone  
#define LOW_TONE_PPS_MAX        8.2
#define LOW_TONE_PPS_MIN        1.5
#define LOW_TONE_HZ           400                 // freq of low tone
#define TONE_RAMP_TIME         15                 // millisec
#define STALL_RAMP_TIME         5                 // millisec

// serial baud rates
#define BAUDRATE_CONSOLE       921600
#define BAUDRATE_BOOM          115200 
#define BAUDRATE_EFIS          115200
#define BAUDRATE_WIFI         1000000             // 921600 is glicthy on this port

// serial data timeouts
#define EFIS_DATA_TIMEOUT          1000           // milliseconds
#define BOOM_DATA_TIMEOUT          1000           // milliseconds  

// efis serial defines
#define DYNON_SERIAL_LEN             53           // 53 with live data, 52 with logged data

#define TONE_PIN              30                  // or also 29 for dual output
#define TESTPOT_PIN           A20                 // pin 39 on Teensy 3.6, pin 10 on DB15
#define VOLUME_PIN            A20                 // pin 39 used for audio volume, pin 10 on DB15
#define PIN_LED1              13                  // internal LED for showing serial input state.
#define PIN_LED2              5                   // external LED for showing AOA status (audio on/off)
#define FLAP_PIN              A2                  // flap position switch  (pin 7 on DB15)
#define OAT_PIN               33                  // OAT analog input pin
#define SWITCH_PIN            2
#define PULSE_TONE            1
#define SOLID_TONE            2
#define TONE_OFF              3
#define STARTUP_TONES_DELAY   120
#define RANGESWEEP_LOW_AOA    0
#define RANGESWEEP_HIGH_AOA   20
#define RANGESWEEP_STEP       .1                  // degrees AOA

//ï»¿DB15 pinout (Gen2 v3 hardware)
//1 - 14V +PWR
//2 - EFIS Serial RX
//3 - PANEL SWITCH
//4 - GPS Serial RX
//5 - LED+ Digital/PWM
//6 - AUDIO RIGHT
//7 - FLAPS Analog IN
//8 - AUDIO LEFT
//9 - OAT Analog IN  (or Display Serial out)
//10 - VOLUME Analog IN
//11 - SENSOR PWR 3.3V
//12 - EFIS Serial TX
//13 - BOOM TTL RX
//14 - GND
//15 - AUDIO GND 


// IMU defines

#ifdef IMUTYPE_LSM9DS1
  #define LSM9DS1_Magnet    0x1E
  // LSM9DS1 Accel/Gyro (XL/G) Registers
  #define CTRL_REG5_XL            0x1F
  #define CTRL_REG6_XL            0x20
  #define CTRL_REG7_XL            0x21
  #define OUT_X_L_XL              0x28
  #define CTRL_REG4               0x1E
  #define CTRL_REG1_G             0x10
  #define OUT_X_L_G               0x18
  #define OUT_TEMP_L              0x15
  #define OUT_TEMP_H              0x16
  #define CTRL_REG8               0x22
  #define CTRL_REG9               0x23
  #define STATUS_REG_1            0x27            // status register, is data available?
  #define FIFO_CTRL               0x2E            // enable FIFO in IMU
  #define FIFO_SRC                0x2F            // FIFO status register
  #define LSM9DS1_TEMP_SCALE      16.0
  #define LSM9DS1_TEMP_BIAS       25.0
  #define _i2cAddress_AccelGyro   0x6B            // chip address
  #define aRes               8.0 / 32768.0        // full scale /resolution (8G)
  #define gRes             245.0 / 32768.0        // full scale / resolution (245 dps)
#endif

#ifdef IMUTYPE_ISM330DHCX
  // define ISM330 registers
  #define _i2CAddressISM330       0x6A            // chip address on I2C bus
  #define CTRL1_XL                0x10            // accelerometer control register  
  #define CTRL2_G                 0x11            // gyro control register
  #define CTRL3_C                 0x12
  #define CTRL4_C                 0x13
  #define CTRL9_XL                0x18
  #define CTRL7_G                 0x16
  #define CTRL6_C                 0x15
  #define OUTX_L_A                0x28            // start of accelerometer output address
  #define OUTX_L_G                0x22            // start of gyro output address
  #define ISM330_OUT_TEMP_L       0x20            // temp output register 
  #define ISM330_OUT_TEMP_H       0x21
  #define FIFO_CTRL4              0x0A
  #define ISM330_TEMP_SCALE      256.0
  #define ISM330_TEMP_BIAS        25.0
  #define aRes               8.0 / 32768.0        // full scale /resolution (8G)
  #define gRes             250.0 / 32768.0        // full scale / resolution (250 dps)

#endif

#define DEG2RAD 0.0174533   // degrees to radians
#define RAD2DEG 57.2958     // radians to degrees
#define G2MPS   9.80665     // g to m/sec^2
#define MPS2G   0.101971621 // m/sec^2 to g
#define FT2M    0.3048      // feet to meters
#define M2FT    3.28084     // meters to feet
#define MPS2FPM 196.85      // m/sec to fpm
#define MPS2KTS 1.94384     // m/sec to fpm
#define KTS2MPS 0.514444    // m/sec to fpm

#define I2C_COMMUNICATION_TIMEOUT 2000  // microseconds

#define SD_WRITE_BLOCK_SIZE   512  // block size to write on the SD card. 512 is the most efficient
#define LOG_RINGBUFFER_SIZE 32768  // ringbuffer size

#define _GNU_SOURCE

#include <stdint.h>
#include <i2c_t3.h> // multiport i2c (Wire.h needs to redirect here, otherwise it gets duplicated. Make a Wire.h library with an #include <i2c_t3.h> line in it.

// SD card includes
#include "SdFat.h" // https://github.com/greiman/SdFat  v.2.1.0
EXTERN SdFat Sd;
// SdCardFactory constructs and initializes the appropriate card. Needed for card formatting
EXTERN SdCardFactory cardFactory;
EXTERN_INIT(SdCard* m_card ,  nullptr)
EXTERN_INIT(uint32_t cardSectorCount , 0)
EXTERN uint8_t  sectorBuffer[512];

#include "default_config.h"
#include <Audio.h>      // use local Audio.h with play_sd_raw.h & play_sd_wav.h commented out for SDIO compatibility.
//#include <Gaussian.h>         // gaussian lib used for avg out AOA values.
//#include <LinkedList.h>       // linked list is also required.
//#include <GaussianAverage.h>  // more info at https://github.com/ivanseidel/Gaussian
#include <OneButton.h>      // button click/double click detection https://github.com/mathertel/OneButton
#include <RunningMedian.h> // https://github.com/RobTillaart/Arduino/tree/master/libraries/RunningMedian
#include "RunningAverage.h" //https://github.com/RobTillaart/Arduino/tree/master/libraries/RunningAverage
#include "AudioSampleEnabled.h"
#include "AudioSampleDisabled.h"
#include "AudioSampleOnspeed_left_speaker.h"
#include "AudioSampleOnspeed_right_speaker.h"
#include "AudioSampleDatamark.h"
#include "AudioSampleGlimit.h"
#include "AudioSampleVnochime.h"
#include "MadgwickFusion.h"
#include "KalmanFilter.h"
#include <SavLayFilter.h>

#ifdef OAT_AVAILABLE
  // set up the digital temperature sensor
  #include <OneWire.h> //https://github.com/PaulStoffregen/OneWire
  #include <DallasTemperature.h> //https://github.com/milesburton/Arduino-Temperature-Control-Library
  #define ONE_WIRE_BUS 33
EXTERN   OneWire oneWire(ONE_WIRE_BUS);
EXTERN   DallasTemperature oatSensor(&oneWire);
#endif


EXTERN Madgwick filter;
EXTERN KalmanFilter kalman;
//double imuTempDerivativeInput;
//SavLayFilter imuTempDerivative (&imuTempDerivativeInput, 1, 15); //Computes the first derivative

EXTERN double iasDerivativeInput;
EXTERN_CLASS(SavLayFilter iasDerivative, &iasDerivativeInput, 1, 15);   //Computes the first derivative


EXTERN_INIT(volatile float kalmanAlt, 0)  // meters, Kalman filtered pressure altitude
EXTERN_INIT(volatile float kalmanVSI, 0)  // m/sec, Kalman filtered instantaneous vertical speed


EXTERN_INIT(volatile float smoothedPitch, 0)
EXTERN_INIT(volatile float smoothedRoll, 0)

// audio mixer config
EXTERN AudioSynthWaveformSine   sinewave1;
EXTERN AudioEffectEnvelope      envelope1;
EXTERN AudioPlayMemory          voice1;
EXTERN AudioMixer4              mixer1;
EXTERN AudioOutputAnalogStereo  dacs;
EXTERN AudioAmplifier           ampLeft;
EXTERN AudioAmplifier           ampRight;
EXTERN_CLASS(AudioConnection          patchCord1, sinewave1, envelope1)
EXTERN_CLASS(AudioConnection          patchCord2, envelope1, 0, mixer1, 0)
EXTERN_CLASS(AudioConnection          patchCord3, voice1, 0, mixer1, 2)
EXTERN_CLASS(AudioConnection          patchCord4, mixer1, ampLeft)
EXTERN_CLASS(AudioConnection          patchCord5, mixer1, ampRight)
EXTERN_CLASS(AudioConnection          patchCord6, ampLeft, 0, dacs, 0)
EXTERN_CLASS(AudioConnection          patchCord7, ampRight, 0, dacs, 1)

// rangesweep direction
EXTERN_INIT(int rangeSweepDirection, 1) // positive
   
EXTERN_INIT(volatile float efisIAS, 0.00)
EXTERN_INIT(volatile float DecelRate, 0.00)
EXTERN_INIT(volatile float efisPitch, 0.00)
EXTERN_INIT(volatile float efisRoll, 0.00)
EXTERN_INIT(volatile float efisLateralG, 0.00)
EXTERN_INIT(volatile float efisVerticalG, 0.00)
EXTERN_INIT(volatile int efisPercentLift, 0)
EXTERN_INIT(volatile int efisPalt, 0)
EXTERN_INIT(volatile int efisVSI, 0)
EXTERN volatile float efisTAS;
EXTERN volatile float efisOAT;
EXTERN_INIT(volatile float efisFuelRemaining, 0.00)
EXTERN_INIT(volatile float efisFuelFlow, 0.00)
EXTERN_INIT(volatile float efisMAP, 0.00)
EXTERN_INIT(volatile int efisRPM, 0)
EXTERN_INIT(volatile int efisPercentPower, 0)
EXTERN_INIT(volatile int efisHeading, -1)
EXTERN_INIT(String efisTime, "")
EXTERN_INIT(volatile unsigned long efisTimestamp, millis())
EXTERN_INIT(String efisType, "")
EXTERN_INIT(int efisID, 0) // 0= none, 1=VN-300, 2=AFS/SkyView, 3=Dynon D10, 4=G5, 5=G3X, 6=MGL
EXTERN_INIT(String calSource, "")
EXTERN_INIT(bool efisPacketInProgress, false)
EXTERN unsigned long lastReceivedEfisTime;
EXTERN_INIT(int efis_bufferIndex, 0)
EXTERN_INIT(String efisBufferString, "")

EXTERN char efis_inChar;                          // efis serial character
EXTERN_INIT(char last_efis_inChar, char(0x00))
EXTERN_INIT(byte previousEfisByte, 0x00)
EXTERN_INIT(int efisLateralGColumn, 16)
EXTERN_INIT(volatile int charsreceived, 0)        // debug
EXTERN_INIT(volatile int cachelinecount, 0)       //debug variable
EXTERN_INIT(volatile bool readingSerial, false)   // serial port being read
EXTERN_INIT(volatile bool readingSensors, false)
EXTERN_INIT(volatile int efisMaxAvailable, 0)

   
//vectornav variables
EXTERN_INIT(volatile float vnAngularRateRoll, 0.00)
EXTERN_INIT(volatile float vnAngularRatePitch, 0.00)
EXTERN_INIT(volatile float vnAngularRateYaw, 0.00)
EXTERN_INIT(volatile float vnVelNedNorth, 0.00)
EXTERN_INIT(volatile float vnVelNedEast, 0.00)
EXTERN_INIT(volatile float vnVelNedDown, 0.00)
EXTERN_INIT(volatile float vnAccelFwd, 0.00)
EXTERN_INIT(volatile float vnAccelLat, 0.00)
EXTERN_INIT(volatile float vnAccelVert, 0.00)
EXTERN_INIT(volatile float vnYaw, 0.00)
EXTERN_INIT(volatile float vnPitch, 0.00)
EXTERN_INIT(volatile float vnRoll, 0.00)
EXTERN_INIT(volatile float vnLinAccFwd, 0.00)
EXTERN_INIT(volatile float vnLinAccLat, 0.00)
EXTERN_INIT(volatile float vnLinAccVert, 0.00)
EXTERN_INIT(volatile float vnYawSigma, 0.00)
EXTERN_INIT(volatile float vnRollSigma, 0.00)
EXTERN_INIT(volatile float vnPitchSigma, 0.00)
EXTERN_INIT(volatile float vnGnssVelNedNorth, 0.00)
EXTERN_INIT(volatile float vnGnssVelNedEast, 0.00)
EXTERN_INIT(volatile float vnGnssVelNedDown, 0.00)
EXTERN_INIT(volatile byte vnGPSFix, 0)
EXTERN_INIT(volatile double vnGnssLat, 0.00L)     // 8 byte double
EXTERN_INIT(volatile double vnGnssLon, 0.00L)
EXTERN_INIT(String vnTimeUTC, "")
EXTERN byte vnBuffer[127];
EXTERN_INIT(byte vnBufferIndex, 0)
EXTERN_INIT(int mglMsgLen, 0)

// pressure variables
EXTERN volatile int Pfwd;
EXTERN volatile float PfwdPascal;
EXTERN_INIT(volatile float Pstatic, 0.00)
EXTERN volatile int P45;
EXTERN volatile float PfwdSmoothed;
EXTERN volatile float P45Smoothed;

// boom variables
EXTERN String boomBufferString;
EXTERN unsigned long lastReceivedBoomTime;
EXTERN_INIT(volatile int boomMaxAvailable, 0)
EXTERN_INIT(volatile float boomStatic, 0.0)
EXTERN_INIT(volatile float boomDynamic, 0.0)
EXTERN_INIT(volatile float boomAlpha, 0.0)
EXTERN_INIT(volatile float boomBeta, 0.0)
EXTERN_INIT(volatile float boomIAS, 0.0)
EXTERN_INIT(volatile unsigned long boomTimestamp, millis())

EXTERN char parseBuffer[10];
EXTERN_INIT(int parseBufferSize, 0)

EXTERN_CLASS(OneButton Switch, SWITCH_PIN, true)  // pin 2  used for the switch input

EXTERN FsFile SensorFile;
EXTERN FsFile ListFile;
EXTERN char filenameSerial[14];
EXTERN char filenameSensor[14];
EXTERN_INIT(bool sdLogging, false)
EXTERN_INIT(bool sdLoggingConfig, false)
EXTERN_INIT(bool sdAvailable, false)
EXTERN int filesendtimer;
EXTERN bool filesendtimeout;

EXTERN_INIT(volatile uint8_t toneState ,  false)
EXTERN volatile bool switchState;
EXTERN_INIT(volatile byte toneMode ,  PULSE_TONE) // current mode of tone.  PULSE_TONE, SOLID_TONE, or TONE_OFF
EXTERN_INIT(volatile byte tonePlaying ,  TONE_OFF)
EXTERN_INIT(volatile boolean highTone ,  false)   // are we playing high tone or low tone?
EXTERN_INIT(volatile uint32_t toneFreq ,  0)      // store current freq of tone playing.
EXTERN_INIT(volatile float pps ,  20)             // store current PPS of tone (used for debuging) 
//EXTERN float current_delay=1000/pps;            // 1000/pps, tone timer update rate
EXTERN_INIT(volatile float AOA ,  0.0)            // avaraged AOA value is stored here.
EXTERN_INIT(volatile float flightPath, 0.0)
EXTERN_INIT(volatile float derivedAOA, 0.0)
EXTERN_INIT(volatile float LDmaxAOA, 0.00)
EXTERN_INIT(volatile float onSpeedAOAfast, 0.00)
EXTERN_INIT(volatile float onSpeedAOAslow, 0.00)
EXTERN_INIT(volatile float stallWarningAOA, 0.00)
EXTERN_INIT(volatile float stallAOA, 0.00)
EXTERN_INIT(volatile float maneuveringAOA, 0.00)

EXTERN_INIT(volatile float percentLift, 0.0)      // normalized angle of attack, or lift %
EXTERN_INIT(volatile float IAS ,  0.0)            // live Air Speed Indicated
EXTERN_INIT(volatile float smoothedIAS, 0.0)      // smoothed airspeed
EXTERN_INIT(volatile float smoothedIASdiff, 0.0)  // smoothed airspeed
EXTERN_INIT(volatile float smoothedTAS, 0.0)      // smoothed airspeed
EXTERN_INIT(volatile float prevIAS, 0.0)          // previous IAS sample (used to calculate acceleartion)
EXTERN_INIT(volatile float Palt, 0.00)            // pressure altitude
EXTERN_INIT(volatile float OAT, 0.00)

EXTERN_INIT(float currentRangeSweepValue, RANGESWEEP_LOW_AOA)
EXTERN_CLASS(RunningMedian P45Median, pressureSmoothing)
EXTERN_CLASS(RunningMedian PfwdMedian, pressureSmoothing)
EXTERN_CLASS(RunningMedian BaroMedianMillibars, pressureSmoothing)
EXTERN_CLASS(RunningAverage PfwdAvg, 10)
EXTERN_CLASS(RunningAverage P45Avg, 10)
EXTERN_CLASS(RunningAverage IASdiffAvg, iasSmoothing)
EXTERN_CLASS(RunningAverage TASAvg, tasSmoothing)
//EXTERN RunningAverage aVertAvg(accSmoothing);
//EXTERN RunningAverage aLatAvg(accSmoothing);
//EXTERN RunningAverage aFwdAvg(accSmoothing);
EXTERN_CLASS(RunningAverage GxAvg, gyroSmoothing)
EXTERN_CLASS(RunningAverage GyAvg, gyroSmoothing)
EXTERN_CLASS(RunningAverage GzAvg, gyroSmoothing)
//EXTERN RunningAverage aVertCompAvg(compSmoothing);
//EXTERN RunningAverage aLatCompAvg(compSmoothing);
//EXTERN RunningAverage aFwdCompAvg(compSmoothing);
EXTERN_CLASS(RunningAverage aVertCorrAvg, accSmoothing)
EXTERN_CLASS(RunningAverage aLatCorrAvg, accSmoothing)
EXTERN_CLASS(RunningAverage aFwdCorrAvg, accSmoothing)
EXTERN_CLASS(RunningAverage imuTempAvg, imuTempSmoothing)
//EXTERN RunningAverage imuTempRateAvg(imuTempRateSmoothing);


// vars for converting AOA scale value to PPS scale value.
EXTERN int OldRange,  OldValue;
EXTERN float NewRange, NewValue;

EXTERN char inChar;                               // store single serial input char here.
EXTERN char serialCmdChar;                        // usb serial command character
EXTERN char serialWifiCmdChar;                    // wifi serial command character

EXTERN char serialBoomChar;                       // boom serial character
EXTERN_INIT(int serialCmdBufferSize , 0)          // usb serial command buffer size
EXTERN char serialCmdBuffer[51];                  // usb serial command buffer

EXTERN_INIT(int serialWifiCmdBufferSize ,  0)     // usb serial command buffer size
EXTERN char serialWifiCmdBuffer[3072];            // usb serial command buffer

EXTERN_INIT(int serialBufferSize ,  0)            // serial buffer size (boom data)
EXTERN char serialBuffer[51];                     // serial 1  buffer (boom data)

EXTERN char listfileFileName[14];                 // file name for sd card file listing operations
EXTERN bool listfileIsDirectory;      

#define MAXSIZE 90                                // max length of string
EXTERN char input[MAXSIZE+1];                     // buffer for full serial data input string.
EXTERN_INIT(int inputPos ,  0)                    // current postion of serial data.
EXTERN char tempBuf[90];                          // misc char buffer used for debug
EXTERN char logBufSerial[50];                     // char buffer for serial logging

EXTERN_INIT(unsigned long last_time ,  millis())
EXTERN char datalogRingBuffer[LOG_RINGBUFFER_SIZE]; //64Kbytes ringbuffer for datalog
EXTERN_INIT(volatile int datalogRingBufferStart, 0) 
EXTERN_INIT(volatile int datalogRingBufferEnd, 0) 
EXTERN_INIT(volatile unsigned int datalogBytesAvailable, 0)

// IMU variables

EXTERN volatile float ax, ay, az; // ax -instantaneous
EXTERN volatile float aVert, aLat, aFwd, aVertComp, aLatComp, aFwdComp;
EXTERN volatile float gx, gy, gz; // gx - instantaneous
EXTERN volatile float imuTemp;
//EXTERN volatile float imuTempRate;
// IMU values in aircraft orientation
EXTERN_INIT(volatile float Ax, 0.0) 
EXTERN_INIT(volatile float Ay, 0.0)
EXTERN_INIT(volatile float Az, 0.0)
EXTERN_INIT(volatile float Gx, 0.0)
EXTERN_INIT(volatile float Gy, 0.0)
EXTERN_INIT(volatile float Gz, 0.0)

EXTERN_INIT(volatile float LateralGSmoothed, 0.0)
EXTERN_INIT(volatile float PaltSmoothed, 0.0)
EXTERN_INIT(volatile float VerticalGSmoothed, 1.0)  // start at 1G;
EXTERN_INIT(volatile float IASsmoothed, 0.0)
EXTERN volatile float gRoll,gPitch,gYaw;
EXTERN_INIT(volatile float accPitch, 0.0)         // smoothed pitch 
EXTERN_INIT(volatile float accRoll, 0.0)          // smoothed pitch 
EXTERN_INIT(volatile float gyroPitch, 0.0)        // for debug
EXTERN_INIT(volatile float gyroRoll, 0.0)         // for debug
EXTERN_INIT(volatile float rawPitch, 0.0)         // raw pitch


//uint8_t Ascale = 0;     // accel = +/-2G scale
EXTERN_INIT(uint8_t Ascale ,  3)                  // accel = +/-8G scale
EXTERN_INIT(uint8_t Aodr ,  B100)                 // accel data sample rate,  AODR_238Hz
EXTERN_INIT(uint8_t Abw ,  B10)                   // accel data bandwidth 105Hz
EXTERN_INIT(uint8_t Gscale ,  0)                  // 245 degree/sec
EXTERN_INIT(uint8_t Godr ,  B100)                 // GODR_238Hz
EXTERN_INIT(uint8_t Gbw ,  B11)                   // Gyro bandwith

//EXTERN uint8_t Ascale = 3;     // accel full scale, 8G
//EXTERN uint8_t Aodr = 2;   // accel data sample rate,  AODR_59.5Hz
//EXTERN uint8_t Abw = 0;      // accel data bandwidth,  211 Hz
//EXTERN uint8_t Gscale = 0;   // 245 degree/sec
//EXTERN uint8_t Godr = 2;     // GODR_59Hz
//EXTERN uint8_t Gbw = 0;    // 16 Hz at Godr = 59.5 Hz
//EXTERN float aRes=0.000244140625; // 8g / 32768.0
//EXTERN float gRes=500.0 / 32768.0; // full scale / resolution
//EXTERN uint8_t Ascale = 3;     // accel full scale, 8G
//EXTERN uint8_t Aodr = 6;   // accel data sample rate,  AODR_952Hz
//EXTERN uint8_t Abw = 3;      // accel data bandwidth,  ABW_50Hz
//EXTERN uint8_t Gscale = 1;   // 500 degree/sec
//EXTERN uint8_t Godr = 6;     // GODR_952Hz
//EXTERN uint8_t Gbw = 2;    // 58 Hz at Godr = 952 Hz


EXTERN IntervalTimer ToneTimer;
EXTERN IntervalTimer SensorTimer;                 // read sensors
EXTERN IntervalTimer PotTimer;                    // read potentiometer           
EXTERN IntervalTimer RangeSweepTimer;             // sweep through AOA range, high to low
EXTERN IntervalTimer LogReplayTimer;
EXTERN IntervalTimer IMUTimer;                    // read IMU

// volume variables
EXTERN_INIT(float LOW_TONE_VOLUME      ,  .25)    // volume is 0 to 1
EXTERN_INIT(float HIGH_TONE_VOLUME_MIN ,  .25)    // high tone will ramp up from min to max
EXTERN_INIT(float SOLID_TONE_VOLUME    ,  .25)
EXTERN_INIT(float HIGH_TONE_VOLUME_MAX ,  1)
EXTERN_INIT(int volPos, 0)
EXTERN_INIT(int avgSlowVolPos, 512)
EXTERN_INIT(unsigned long volumeStartTime, millis())
EXTERN_INIT(volatile int flapsPos, 0) // in degrees
EXTERN_INIT(volatile int flapsIndex, 0)
EXTERN_INIT(int loopcount, 0)
EXTERN_INIT(unsigned long looptime, millis())

// Function prototypes from converted INO files
// --------------------------------------------

// 3DAudio.ino
void Check3DAudio();
// AHRS.ino
void processAHRS();
float calcPitch(float aFwd,float aLat,float aVert);
float calcRoll(float aFwd,float aLat,float aVert);
// AOAcalc.ini
void calcAOA (float Pfwd, float P45);
void setAOApoints(int flapIndex);
// BoomSerial.ino
void readBoomSerial();
// CheckSerial.ino
void checkSerial();
// ConfigFunctions.ino
bool loadConfigurationFile(char* filename);
bool saveConfigurationToFile(char* filename, String configString);
bool loadDefaultConfiguration();
void LoadConfig();
// CurveCalc.ino
float curveCalc(float x, calibrationCurve curve );
// DataSource.ino
void setDataSourceMode();
// DisplaySerial.ino
void writeSerialData();
// EfisSerial.ino
void readEfisSerial();
// Flaps.ino
int getFlapsIndex();
// gLimit.ino
void checkGlimit();
// HeartBeat.ino
void heartBeat();
// HelperFunctions.ino
float mapfloat(float x, float in_min, float in_max, float out_min, float out_max);
void _softRestart();
int freeMemory();
float array2float(byte buffer[], int startIndex);
long double array2double(byte buffer[], int startIndex);
void configChecksum(String &configString, String &checksumString);
// IMUread.ino
void initAccelGyro();
void resetAccelGyro();
void readAccelGyro(bool tempUpdate=true);
float scaleAccel(int16_t accel);
float scaleGyro(int16_t gyro);
void configureAxes();
float getAccelForAxis(String accelAxis);
float getGyroForAxis(String gyroAxis);
float getGyroForAxisnoBias(String gyroAxis);
float getGyroForAxisnoBias(String gyroAxis);
void ReadIMU();
// i2c.ino
uint8_t I2CreadByte(uint8_t i2cAddress, uint8_t registerAddress);
void I2CwriteByte(uint8_t i2cAddress, uint8_t registerAddress, uint8_t data);
uint8_t I2CreadBytes(uint8_t i2cAddress, uint8_t registerAddress, uint8_t * dest, uint8_t count);
uint8_t I2CreadBytesISM330(uint8_t i2cAddress, uint8_t registerAddress, uint8_t * dest, uint8_t count);
void initI2C();
// LogData.ino
void logData();
void createLogFile();
// LogReplay.ino
void LogReplay();
void PotRead();
void RangeSweep();
float getTestAOA();
// SD_readwrite.ino
void SensorWriteSD();
void datalogRingBufferAdd(char * logBuffer);
int minimum(int a,int b);
// SendWifiData.ino
void SendWifiData();
// SensorRead.h
int GetPressureP45();
int GetPressurePfwd();
float GetStaticPressure();
void SensorRead();
// Switch.ino
void switchOnOff();
void switchCheck();
void SwitchSingleClick();
void SwitchLongPress();
// Timers.ino
void timersOff();
void timersOn();
// Tones.ino
void setFrequencytone(uint32_t frequency);
void tonePlayHandler();
void updateTones();
void setPPSTone(float newPPS);
// USBserial.ino
void readUSBSerial();
void displayConsoleHelp();
// VnoChime.ino
void checkVnoChime();
// Volume.ino
void checkVolume();
void setVolume(int volumePercent);
// Watchdog.ino
void enableWatchdog();
void watchdogRefresh();
void checkWatchdog();
// WifiSerial.ino
void readWifiSerial();
void sendWifiSerialString(String serialString);


// Onspeed-settigsFunctions.h
bool                stringToBoolean(String configString);
float               stringToFloat(String string);
String              floatToString(float value);
intArray            parseIntCSV(String configString);
floatArray          parseFloatCSV(String configString, int limit=MAX_AOA_CURVES);
calibrationCurve    parseCurveCSV(String configString);
String              getConfigValue(String configString,String configName);
String              makeConfig(String configName,String configValue);
String              curve2string(calibrationCurve configArray);
String              float_array2string(floatArray configArray);
String              int_array2string(intArray configArray);
void                configurationToString(String &configString);
bool                loadConfigFromString(String configString);
void                addCRC(String &configString);


#endif // defined GLOBALS_H